id: 693
name: turnstileOnSubmit
description: 'Load Cloudflare form protection.'
category: m_fb_antispam
properties: 'a:2:{s:13:"elementStatus";a:7:{s:4:"name";s:13:"elementStatus";s:4:"desc";s:0:"";s:4:"type";s:9:"textfield";s:7:"options";a:0:{}s:5:"value";s:12:"experimental";s:7:"lexicon";s:20:"romanesco:properties";s:4:"area";s:0:"";}s:14:"elementPreview";a:7:{s:4:"name";s:14:"elementPreview";s:4:"desc";s:0:"";s:4:"type";s:9:"textfield";s:7:"options";a:0:{}s:5:"value";s:0:"";s:7:"lexicon";s:20:"romanesco:properties";s:4:"area";s:0:"";}}'

-----

<div class="cf-turnstile"
     data-sitekey="[[++formblocks.turnstile_site_key]]"
     data-theme="[[++formblocks.turnstile_theme:default=`light`]]"
     data-size="[[++formblocks.turnstile_size:default=`normal`]]"
     data-callback="onTurnstileSuccess[[+form_id]]"
     data-error-callback="onTurnstileError[[+form_id]]"
     data-expired-callback="onTurnstileExpired[[+form_id]]"
>
</div>

<script>
    window.addEventListener('DOMContentLoaded', function() {

        const form = document.querySelector('form[name="fb[[+form_id]]"]');
        const submit = form.querySelector('input[name="fb[[+form_id]]-submit"][type="submit"]');

        if (!form) {
            console.error('Turnstile couldn\'t find its parent form.');
            return;
        }

        submit.classList.add('disabled');

        window.onTurnstileSuccess[[+form_id]] = function (token) {
            //console.log('Challenge success', token);
            submit.classList.remove('disabled');
        }
        window.onTurnstileError[[+form_id]] = function (errorCode) {
            console.log('Challenge error:', errorCode);
        }
        window.onTurnstileExpired[[+form_id]] = function () {
            console.log('Token expired');
            submit.classList.add('disabled');
        }
    });
</script>
